#!/bin/bash

COMMIT_MSG_FILE=$1
PROJECT_ROOT=$(git rev-parse --show-toplevel)
SCRIPT_PATH="$PROJECT_ROOT/autocommit_python/ai_commit_message.py"

DIFF=$(git diff --cached | head -c 6000)

# 브랜치명에서 식별자 추출 (예: feature/auth/login-page → login-page)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
BRANCH_ID=$(echo "$BRANCH" | awk -F'/' '{print $NF}')

# staged 변경사항이 없으면 종료
if [ -z "$DIFF" ]; then
    echo "staged 변경사항이 없습니다."
    exit 0
fi

AUTOCOMMIT_DIR="$PROJECT_ROOT/autocommit_python"

RESULT=$(cd "$AUTOCOMMIT_DIR" && uv run python "$SCRIPT_PATH" "$DIFF" "$BRANCH_ID" 2>&1)

if [ $? -ne 0 ]; then
    echo "❌ AI 커밋 메시지 생성 실패: $RESULT"
    exit 1
fi

echo "$RESULT" > "$COMMIT_MSG_FILE"
